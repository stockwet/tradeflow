<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradeFlow Monitor</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <header>
        <h1>TradeFlow Monitor</h1>
        <p class="subtitle">Real-time order flow sonification</p>
      </header>

      <!-- Mode Selector -->
      <div class="mode-selector">
        <div class="mode-row">
          <label for="data-mode">Data Source</label>
          <select id="data-mode">
            <option value="websocket">Live (WebSocket)</option>
            <option value="playback">CSV Playback</option>
          </select>

          <div id="websocket-status" style="display: flex; align-items: center; gap: 10px">
            <button id="reconnect-btn" class="connect-btn">
              <span class="conn-dot disconnected"></span>
              <span class="conn-label">Connect</span>
            </button>

          </div>
        </div>

        <div class="mode-row">
          <label for="audio-alert-mode">Audio Mode</label>
          <select id="audio-alert-mode">
            <option value="raw">Raw (every trade)</option>
            <option value="intelligent">Intelligent (filtered)</option>
            <option value="transition">Transition Detection</option>
            <option value="velocity">Velocity Pulse</option>

          </select>
          <button id="open-settings-btn">âš™ Settings</button>
        </div>
      </div>

      <!-- Main Layout -->
      <div class="main-layout">
        <!-- Left Panel: VU Meter -->
        <div class="left-panel">
          <div class="vu-meter-container">
            <div class="meter-label">TradeFlow Monitor</div>
            <canvas id="vu-meter-canvas"></canvas>
          </div>

          <div class="imbalance-meter-wrap">
            <div class="imbalance-meter-label">Vol/Sec Imbalance</div>
            <canvas id="imbalance-meter"></canvas>
          </div>
        </div>

        <!-- Right Panel: Playback + Stats -->
        <div class="right-panel">
          <!-- Playback Controls -->
          <div
            id="playback-controls"
            class="playback-controls"
            style="display: none"
          >
            <h3 style="margin-bottom: 15px">CSV Playback</h3>

            <div class="control-group">
              <label for="csv-file">Load CSV File:</label>
              <input type="file" id="csv-file" accept=".csv" />
            </div>

            <div class="button-group">
              <button id="play-btn">Play</button>
              <button id="pause-btn">Pause</button>
              <button id="stop-btn">Stop</button>
            </div>

            <div class="control-group">
              <label for="playback-speed">
                Playback Speed:
                <span id="speed-value" class="value-display">1.0x</span>
              </label>
              <input
                type="range"
                id="playback-speed"
                min="0.1"
                max="5"
                step="0.1"
                value="1"
              />
            </div>
          </div>

          <!-- Stats (Tabular) -->
          <div class="stats">
            <div class="stats-header">
              <h3>Statistics</h3>
              <button id="reset-stats-btn" class="reset">Reset</button>
            </div>

            <table
              class="stats-table"
              role="table"
              aria-label="Trade statistics"
            >
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Sell</th>
                  <th scope="col">Buy</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">Trades</th>
                  <td>
                    <span class="stat-value sell" id="sell-count">0</span>
                  </td>
                  <td><span class="stat-value buy" id="buy-count">0</span></td>
                </tr>

                <tr>
                  <th scope="row">Volume</th>
                  <td>
                    <span class="stat-value sell" id="sell-volume">0</span>
                  </td>
                  <td><span class="stat-value buy" id="buy-volume">0</span></td>
                </tr>

                <tr>
                  <th scope="row">Vol / Trade</th>
                  <td>
                    <span class="stat-value sell" id="sell-vol-per-trade">0.0</span>
                  </td>
                  <td>
                    <span class="stat-value buy" id="buy-vol-per-trade">0.0</span>
                  </td>
                </tr>

                <tr>
                  <th scope="row">Trades / Second</th>
                  <td>
                    <span class="stat-value sell" id="sell-trades-per-sec"
                      >0.0</span
                    >
                  </td>
                  <td>
                    <span class="stat-value buy" id="buy-trades-per-sec"
                      >0.0</span
                    >
                  </td>
                </tr>

                <tr>
                  <th scope="row">Vol / Second</th>
                  <td>
                    <span class="stat-value sell" id="sell-vol-per-sec"
                      >0.0</span
                    >
                  </td>
                  <td>
                    <span class="stat-value buy" id="buy-vol-per-sec">0.0</span>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Keep this for compatibility -->
            <span id="events-per-sec" style="display: none">0.0</span>
          </div>


        </div>
      </div>
    </div>

    <!-- Settings Drawer -->
    <div id="settings-overlay" class="overlay" style="display: none"></div>

    <aside id="settings-drawer" class="drawer" aria-hidden="true">
      <div class="drawer-header">
        <h3>Settings</h3>
        <button id="close-settings-btn" class="drawer-close">Close</button>
      </div>

      <div class="drawer-body">
        <!-- Audio Settings (always visible) -->
        <div class="drawer-section">
          <h4>Audio Settings</h4>

          <div class="drawer-row">
            <label for="aggregate-orders">Aggregate Orders</label>
            <input type="checkbox" id="aggregate-orders">
          </div>

          <div class="control-group">
            <label for="master-volume">
              Master Volume:
              <span id="volume-value" class="value-display">70%</span>
            </label>
            <input
              type="range"
              id="master-volume"
              min="0"
              max="200"
              value="70"
            />
          </div>

          <div class="control-group">
            <label for="bid-frequency">
              BID Frequency:
              <span id="bid-freq-value" class="value-display">100 Hz</span>
            </label>
            <input
              type="range"
              id="bid-frequency"
              min="0"
              max="2000"
              step="10"
              value="100"
            />
          </div>

          <div class="control-group">
            <label for="ask-frequency">
              ASK Frequency:
              <span id="ask-freq-value" class="value-display">1000 Hz</span>
            </label>
            <input
              type="range"
              id="ask-frequency"
              min="0"
              max="2000"
              step="10"
              value="1000"
            />
          </div>

          <div class="control-group" style="margin-bottom: 0">
            <label for="sensitivity">
              Meter Sensitivity:
              <span id="sensitivity-value" class="value-display">100%</span>
            </label>
            <input
              type="range"
              id="sensitivity"
              min="0"
              max="100"
              value="100"
            />
          </div>
        </div>

        <!-- Intelligent Mode Settings -->
        <div id="intelligent-settings" class="drawer-section settings-section">
          <h4>Intelligent Mode Settings</h4>

          <div class="drawer-row">
            <label for="engine-windowMs">Window (ms)</label>
            <input
              id="engine-windowMs"
              type="number"
              min="50"
              max="2000"
              step="10"
              value="300"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-dominanceMetric">Dominance Metric</label>
            <select id="engine-dominanceMetric">
              <option value="volume">Volume</option>
              <option value="count">Trade Count</option>
            </select>
          </div>

          <div class="drawer-row">
            <label for="engine-enterDominance">Enter Dominance</label>
            <input
              id="engine-enterDominance"
              type="number"
              min="0.50"
              max="0.99"
              step="0.01"
              value="0.80"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-exitDominance">Exit Dominance</label>
            <input
              id="engine-exitDominance"
              type="number"
              min="0.40"
              max="0.98"
              step="0.01"
              value="0.65"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-minTradesPerSec">Min Trades/sec</label>
            <input
              id="engine-minTradesPerSec"
              type="number"
              min="0"
              max="500"
              step="1"
              value="35"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-maxEventsPerSec">Max Events/sec</label>
            <input
              id="engine-maxEventsPerSec"
              type="number"
              min="1"
              max="200"
              step="1"
              value="8"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-requireSustainedMs"
              >Require Sustained (ms)</label
            >
            <input
              id="engine-requireSustainedMs"
              type="number"
              min="0"
              max="1000"
              step="10"
              value="80"
            />
          </div>

          <div class="drawer-row">
            <label for="engine-lockSideMs">Lock Side (ms)</label>
            <input
              id="engine-lockSideMs"
              type="number"
              min="0"
              max="2000"
              step="10"
              value="150"
            />
          </div>

          <div class="drawer-row" style="margin-bottom: 0">
            <label for="engine-cooldownMs">Cooldown (ms)</label>
            <input
              id="engine-cooldownMs"
              type="number"
              min="0"
              max="2000"
              step="10"
              value="0"
            />
          </div>
        </div>

        <!-- Transition Detection Settings -->
        <div id="transition-settings" class="drawer-section settings-section">
          <h4>Transition Detection Settings</h4>

          <div class="drawer-row">
            <label for="transition-windowMs">Window (ms)</label>
            <input
              id="transition-windowMs"
              type="number"
              min="100"
              max="3000"
              step="100"
              value="1000"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-dominanceMetric">Dominance Metric</label>
            <select id="transition-dominanceMetric">
              <option value="volume">Volume</option>
              <option value="count">Trade Count</option>
            </select>
          </div>

          <div class="drawer-row">
            <label for="transition-thrustThreshold">Thrust Threshold</label>
            <input
              id="transition-thrustThreshold"
              type="number"
              min="0.50"
              max="0.95"
              step="0.05"
              value="0.60"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-thrustChange">Thrust Change</label>
            <input
              id="transition-thrustChange"
              type="number"
              min="0.10"
              max="0.70"
              step="0.05"
              value="0.30"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-thrustMinVelocity">Min Velocity</label>
            <input
              id="transition-thrustMinVelocity"
              type="number"
              min="5"
              max="100"
              step="5"
              value="20"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-pullbackThreshold">Pullback Threshold</label>
            <input
              id="transition-pullbackThreshold"
              type="number"
              min="0.10"
              max="0.70"
              step="0.05"
              value="0.30"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-pullbackFade">Pullback Fade</label>
            <input
              id="transition-pullbackFade"
              type="number"
              min="0.05"
              max="0.50"
              step="0.05"
              value="0.20"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-absorptionThreshold">Absorption Threshold</label>
            <input
              id="transition-absorptionThreshold"
              type="number"
              min="0.05"
              max="0.50"
              step="0.05"
              value="0.20"
            />
          </div>

          <div class="drawer-row">
            <label for="transition-minEventInterval">Min Event Interval (ms)</label>
            <input
              id="transition-minEventInterval"
              type="number"
              min="100"
              max="2000"
              step="100"
              value="500"
            />
          </div>

          <div class="drawer-row" style="margin-bottom: 0">
            <label for="transition-historyDepth">History Depth (sec)</label>
            <input
              id="transition-historyDepth"
              type="number"
              min="1"
              max="10"
              step="1"
              value="3"
            />
          </div>
        </div>

        <!-- Velocity Pulse Settings -->
        <div id="velocity-settings" class="drawer-section settings-section">
          <h4>Velocity Pulse Settings</h4>

          <div class="drawer-row">
            <label for="velocity-baselineWindowMs">Baseline Window (ms)</label>
            <input id="velocity-baselineWindowMs" type="number" min="5000" max="240000" step="1000" value="45000" />
          </div>

          <div class="drawer-row">
            <label for="velocity-sensitivityK">Sensitivity K</label>
            <input id="velocity-sensitivityK" type="number" min="0.1" max="5" step="0.1" value="1.0" />
          </div>

          <div class="drawer-row">
            <label for="velocity-minAbsTradesPerSec">Min Trades/sec</label>
            <input id="velocity-minAbsTradesPerSec" type="number" min="0" max="500" step="0.5" value="4.0" />
          </div>

          <div class="drawer-row">
            <label for="velocity-minAbsVolPerSec">Min Vol/sec</label>
            <input id="velocity-minAbsVolPerSec" type="number" min="0" max="10000" step="0.5" value="6.0" />
          </div>

          <div class="drawer-row">
            <label for="velocity-switchMarginZ">Switch Margin (Z)</label>
            <input id="velocity-switchMarginZ" type="number" min="0" max="5" step="0.1" value="0.6" />
          </div>

          <div class="drawer-row">
            <label for="velocity-minSwitchMs">Min Switch (ms)</label>
            <input id="velocity-minSwitchMs" type="number" min="0" max="2000" step="10" value="60" />
          </div>

          <div class="drawer-row">
            <label for="velocity-minRate">Min Click Rate (Hz)</label>
            <input id="velocity-minRate" type="number" min="0" max="60" step="1" value="3" />
          </div>

          <div class="drawer-row">
            <label for="velocity-maxRate">Max Click Rate (Hz)</label>
            <input id="velocity-maxRate" type="number" min="1" max="120" step="1" value="28" />
          </div>

          <div class="drawer-row">
            <label for="velocity-rateCurve">Rate Curve</label>
            <input id="velocity-rateCurve" type="number" min="0.5" max="5" step="0.1" value="1.7" />
          </div>

          <div class="drawer-row">
            <label for="velocity-fullScaleZPace">Full Scale Z (Pace)</label>
            <input id="velocity-fullScaleZPace" type="number" min="0.5" max="10" step="0.1" value="3.0" />
          </div>

          <div class="drawer-row" style="margin-bottom: 0">
            <label for="velocity-fullScaleZVol">Full Scale Z (Vol)</label>
            <input id="velocity-fullScaleZVol" type="number" min="0.5" max="10" step="0.1" value="3.0" />
          </div>
        </div>

      </div>

      <div class="drawer-footer">
        <button id="reset-settings-btn" class="reset">Reset to Defaults</button>
      </div>
    </aside>

    <script src="components/audio-engine.js"></script>
    <script src="components/vu-meter.js"></script>
    <script src="components/data-player.js"></script>
    <script src="components/event-engine.js"></script>
    <script src="components/transition-detection-engine.js"></script>
    <script src="components/imbalance-meter.js"></script>
    <script src="components/velocity-pulse-engine.js"></script>
    <script src="app.js"></script>
  </body>
</html>